<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Markdown Âú®Á∫øÈ¢ÑËßàÂô®</title>
  
  <!-- Vue3 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.4.21/vue.global.prod.js"></script>
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.4.21/vue.global.js"></script> -->
  
  <!-- Prism.js ‰ª£Á†ÅÈ´ò‰∫Æ -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/themes/prism.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/components/prism-java.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/components/prism-javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/components/prism-python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/components/prism-css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/components/prism-sql.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/components/prism-bash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/components/prism-json.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/components/prism-markdown.min.js"></script>
  
  <!-- Marked.js MarkdownËß£ÊûêÂô® -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/16.1.2/lib/marked.umd.min.js"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root { --toc-width: 300px; --bg-primary: #ffffff; --bg-secondary: #f8f9fa; --bg-header: #2c3e50; --text-primary: #2c3e50; --text-secondary: #6c757d; --border-color: #dee2e6; --accent-color: #3498db; --shadow: 0 2px 10px rgba(0,0,0,0.1); --code-bg: #f6f8fa; --toc-bg: #f8f9fa; }
    [data-theme="dark"] { --bg-primary: #1a1a1a; --bg-secondary: #2d2d2d; --bg-header: #0d1117; --text-primary: #e6e6e6; --text-secondary: #8b949e; --border-color: #30363d; --accent-color: #58a6ff; --shadow: 0 2px 10px rgba(0,0,0,0.3); --code-bg: #161b22; --toc-bg: #2d2d2d; }
    [data-theme="github"] { --bg-primary: #ffffff; --bg-secondary: #f6f8fa; --bg-header: #24292e; --text-primary: #24292e; --text-secondary: #586069; --border-color: #e1e4e8; --accent-color: #0366d6; --shadow: 0 2px 10px rgba(0,0,0,0.1); --code-bg: #f6f8fa; --toc-bg: #f6f8fa; }
    [data-theme="vscode"] { --bg-primary: #1e1e1e; --bg-secondary: #252526; --bg-header: #333333; --text-primary: #cccccc; --text-secondary: #969696; --border-color: #3e3e42; --accent-color: #007acc; --shadow: 0 2px 10px rgba(0,0,0,0.3); --code-bg: #1e1e1e; --toc-bg: #252526; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif; background-color: var(--bg-primary); color: var(--text-primary); transition: all 0.3s ease; min-height: 100vh; display: flex; flex-direction: column; }
    header { background-color: var(--bg-header); color: white; padding: 0.4rem 2rem; box-shadow: var(--shadow); position: sticky; top: 0; z-index: 100; }
    .header-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
    .logo { display: flex; align-items: center; gap: 0.5rem; font-size: 1.4rem; font-weight: bold; }
    .text-center { text-align: center; }
    .cursor { cursor: pointer; }
    .controls { display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; }
    .btn { padding: 0.3rem 0.8rem; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 0.5rem; background-color: var(--accent-color); color: white; }
    .btn.small { padding: 0.2rem 0.5rem; font-size: 0.8rem; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    .btn-secondary { background-color: transparent; border: 1px solid rgba(255,255,255,0.3); }
    .btn-secondary:hover { background-color: rgba(255,255,255,0.1); }
    .theme-selector { display: flex; gap: 0.5rem; align-items: center; }
    .theme-selector select { padding: 0.3rem 0.5rem; border-radius: 6px; border: 1px solid var(--border-color); background-color: var(--bg-secondary); color: var(--text-primary); cursor: pointer; font-size: 0.9rem; }
    main { flex: 1; max-width: 1400px; width: 100%; margin: 0 auto; padding: 2rem; position: relative; }
    .drop-zone { border: 3px dashed var(--border-color); border-radius: 12px; padding: 3rem; text-align: center; transition: all 0.3s ease; background-color: var(--bg-secondary); margin-bottom: 2rem; }
    .drop-zone.dragover { border-color: var(--accent-color); background-color: var(--accent-color); opacity: 0.1; }
    .drop-zone-icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }
    .drop-zone-text { color: var(--text-secondary); font-size: 1.1rem; margin-bottom: 1rem; }
    .content-wrapper { display: none; animation: fadeIn 0.5s ease; }
    .content-wrapper.active { display: flex; gap: 2rem; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
    }
    .content-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); }
    .file-info { color: var(--text-secondary); font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem; }
    .sidebar { flex-shrink: 0; width: var(--toc-width); display: flex; flex-direction: column; }
    .toc-container { background-color: var(--toc-bg); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: var(--shadow); padding: 1rem; overflow-y: auto; max-height: calc(100vh - 200px); position: sticky; top: 114px; }
    .toc-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-color); }
    .toc-title { font-weight: 600; color: var(--text-primary); font-size: 0.9rem; }
    .toc-controls { display: flex; gap: 0.5rem; align-items: center; }
    .toc-toggle { background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 0.25rem; border-radius: 4px; transition: all 0.3s ease; }
    .toc-toggle:hover { background-color: var(--bg-secondary); color: var(--text-primary); }
    .toc-level-selector { display: flex; align-items: center; gap: 0.25rem; }
    .toc-level-selector label { font-size: 0.75rem; color: var(--text-secondary); white-space: nowrap; }
    .toc-level-selector select { padding: 0.25rem 0.5rem; border-radius: 4px; border: 1px solid var(--border-color); background-color: var(--bg-secondary); color: var(--text-primary); cursor: pointer; font-size: 0.75rem; }
    .toc-container.collapsed .toc-content { display: none; }
    .toc-list { list-style: none; padding: 0; margin: 0; }
    .toc-item { margin: 0.25rem 0; }
    .toc-link { display: block; padding: 0.25rem 0.5rem; color: var(--text-secondary); text-decoration: none; font-size: 0.85rem; border-radius: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .toc-link:hover { background-color: var(--bg-secondary); color: var(--accent-color); }
    .toc-link.active { background-color: var(--accent-color); color: white; }
    .toc-level-1 { padding-left: 0.5rem; }
    .toc-level-2 { padding-left: 1.5rem; }
    .toc-level-3 { padding-left: 2.5rem; }
    .toc-level-4 { padding-left: 3.5rem; }
    .toc-level-5 { padding-left: 4.5rem; }
    .toc-level-6 { padding-left: 5.5rem; }
    .main-content { flex: 1; min-width: 0; }
    .markdown-body { background-color: var(--bg-primary); padding: 0 1rem 1rem; border-radius: 8px; line-height: 1.6; overflow-x: auto; }
    .markdown-body h1, .markdown-body h2, .markdown-body h3, .markdown-body h4, .markdown-body h5, .markdown-body h6 { margin-top: 1.5rem; margin-bottom: 1rem; font-weight: 600; line-height: 1.25; scroll-margin-top: 100px; }
    .markdown-body h1 { font-size: 2rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; }
    .markdown-body h2 { font-size: 1.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; }
    .markdown-body h3 { font-size: 1.25rem; }
    .markdown-body h4 { font-size: 1rem; }
    .markdown-body h5 { font-size: 0.875rem; }
    .markdown-body h6 { font-size: 0.85rem; }
    .markdown-body p { margin-bottom: 1rem; }
    .markdown-body a { color: var(--accent-color); text-decoration: none; }
    .markdown-body a:hover { text-decoration: underline; }
    .markdown-body ul, .markdown-body ol { margin-bottom: 1rem; padding-left: 2rem; }
    .markdown-body li { margin-bottom: 0.25rem; }
    .markdown-body blockquote { margin: 1rem 0; padding: 0 1rem; color: var(--text-secondary); border-left: 4px solid var(--border-color); }
    .markdown-body table { border-collapse: collapse; width: 100%; margin-bottom: 1rem; }
    .markdown-body th, .markdown-body td { border: 1px solid var(--border-color); padding: 0.5rem; text-align: left; }
    .markdown-body th { background-color: var(--bg-secondary); font-weight: 600; }
    .markdown-body code { background-color: var(--code-bg); padding: 0.2rem 0.4rem; border-radius: 3px; font-family: 'Consolas', 'Monaco', 'Courier New', monospace; font-size: 0.9em; }
    .markdown-body pre { background-color: var(--code-bg); padding: 1rem; border-radius: 6px; overflow-x: auto; margin-bottom: 1rem; }
    .markdown-body pre code { background: none; padding: 0; }
    .markdown-body img { max-width: 100%; height: auto; border-radius: 6px; margin: 1rem 0; }
    .markdown-body hr { border: none; border-top: 1px solid var(--border-color); margin: 2rem 0; }
    .tooltip { position: fixed; background-color: var(--bg-header); color: white; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; pointer-events: none; opacity: 0; transition: opacity 0.3s ease; z-index: 1000; }
    .tooltip.show { opacity: 1; }
    @media (max-width: 1200px) { .sidebar { width: 220px; } }
    @media (max-width: 768px) { .content-wrapper.active { flex-direction: column; } .sidebar { width: 100%; } .toc-container { max-height: 300px; position: static; } header { padding: 1rem; } .header-content { flex-direction: column; align-items: stretch; } .controls { justify-content: center; } main { padding: 1rem; } .markdown-body { padding: 1rem; } }
    .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s ease-in-out infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .back-to-top { position: fixed; font-size: 20px; bottom: 20px; right: 20px; width: 50px; height: 50px; background-color: var(--accent-color); color: white; border: none; border-radius: 50%; cursor: pointer; display: none; align-items: center; justify-content: center; box-shadow: var(--shadow); transition: all 0.3s ease; z-index: 90; }
    .back-to-top:hover { transform: translateY(-5px); box-shadow: 0 5px 20px rgba(0,0,0,0.3); }
    .back-to-top.show { display: flex; }
    ::-webkit-scrollbar{ width: 10px; height: 10px;}
    ::-webkit-scrollbar-thumb{ background-color: #ddd; border-radius: 6px;}
    .history-bar { background-color: var(--bg-secondary); border-bottom: 1px solid var(--border-color); padding: 0.5rem 1.2rem; display: none; position: sticky; top: 45px; z-index: 99; }
    .history-bar.active { display: block; }
    .history-container { display: flex; overflow-x: auto; gap: 0.5rem; }
    .history-item { flex-shrink: 0; background-color: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 6px; padding: 0.1rem 0.6rem; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; transition: all 0.2s ease; }
    .history-item:hover { border-color: var(--accent-color); box-shadow: var(--shadow); }
    .history-item.active { border-color: var(--accent-color); background-color: var(--accent-color); color: white; }
    .history-item-name { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 0.85rem; }
    .history-item-size { font-size: 0.75rem; color: var(--text-secondary); white-space: nowrap; }
    .history-item.active .history-item-size { color: rgba(255,255,255,0.8); }
    .history-item-delete { background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 0.25rem; border-radius: 4px; display: flex; align-items: center; justify-content: center; }
    .history-item-delete:hover { background-color: rgba(255,0,0,0.1); color: red; }
    .history-item.active .history-item-delete:hover { background-color: rgba(255,255,255,0.2); color: white; }
    .history-empty { color: var(--text-secondary); font-size: 0.85rem; padding: 1rem 0; text-align: center; }
    .code-block-wrapper { position: relative; margin-bottom: 1rem; }
    .copy-button { position: absolute; top: 8px; right: 8px; background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 0.75rem; color: var(--text-secondary); z-index: 10; }
    .temp-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
    .temp-modal.active { display: flex; }
    .temp-modal-content { background: var(--bg-primary); padding: 1.5rem; width: 80%; max-width: 1100px; border-radius: 8px; box-shadow: var(--shadow); }
    .temp-modal textarea { width: 100%; min-height: 62vh; padding: 1rem; margin: 1rem 0; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-secondary); color: var(--text-primary); font-family: monospace; resize: none; outline: none; line-height: 1.3;}
  </style>
</head>
<body>
  <div id="app">
    <header>
      <div class="header-content">
        <div class="logo">
          <span>üìù Markdown È¢ÑËßàÂô®</span>
        </div>
        <div class="controls">
          <input type="file" ref="fileInput" accept=".md,.markdown,.txt" style="display: none;" @change="handleFileSelect">
          <button class="btn" @click="triggerFileInput">üìÇ ÊâìÂºÄÊñá‰ª∂</button>
          <button class="btn btn-secondary" @click="openTempModal">üìù ‰∏¥Êó∂È¢ÑËßà</button>
          <button class="btn btn-secondary" @click="resetContent">üîÑ ÈáçÁΩÆ</button>
          <button class="btn btn-secondary" @click="clearCache" v-if="showClearCacheBtn">üóëÔ∏è Ê∏ÖÈô§ÁºìÂ≠ò</button>
          <div class="theme-selector">
            <label style="color: white;">‰∏ªÈ¢ò:</label>
            <select v-model="theme" @change="changeTheme">
              <option value="light">ÊµÖËâ≤</option>
              <option value="dark">Ê∑±Ëâ≤</option>
              <option value="github">GitHub</option>
              <option value="vscode">VS Code</option>
            </select>
          </div>
        </div>
      </div>
    </header>

    <div class="history-bar" :class="{ active: hasHistory || true }">
      <div class="history-container">
        <div class="history-item" v-for="item in displayHistoryList" :key="item.id" :class="{ active: currentHistoryId === item.id }" @click="loadHistory(item.id)">
          <span class="history-item-name">{{ item.name }}</span>
          <span class="history-item-size">{{ formatFileSize(item.size) }}</span>
          <button class="history-item-delete" v-if="!item.isTemp" @click.stop="deleteHistoryItem(item.id)">‚ùå</button>
        </div>
        <div class="history-empty" v-if="displayHistoryList.length === 0">ÊöÇÊó†ÂéÜÂè≤Êñá‰ª∂</div>
      </div>
    </div>

    <main>
      <div class="drop-zone" ref="dropZone" v-if="!showContent" :class="{ dragover: isDragOver }">
        <div class="drop-zone-icon">üìÑ</div>
        <div class="drop-zone-text">ÊãñÊãΩ Markdown Êàñ TXT Êñá‰ª∂Âà∞ËøôÈáå</div>
        <button class="btn" @click="triggerFileInput">ÊàñÁÇπÂáªÈÄâÊã©Êñá‰ª∂</button>
      </div>

      <div class="content-wrapper" :class="{ active: showContent }">
        <div class="sidebar">
          <div class="content-header">
            <div class="file-info">
              {{ currentFile?.name || 'Êú™ÂëΩÂêçÊñá‰ª∂' }} ({{ formatFileSize(currentFile?.size || 0) }})
              <span class="cursor" @click="downloadFile" v-if="currentFile">‚¨áÔ∏è</span>
            </div>
          </div>
          
          <div class="toc-container" ref="tocContainer" :class="{ collapsed: tocCollapsed }" v-if="hasTOC">
            <div class="toc-header">
              <span class="toc-title">ÁõÆÂΩï</span>
              <div class="toc-controls">
                <div class="toc-level-selector">
                  <label>Â±ÇÁ∫ß:</label>
                  <select v-model="maxTOCLevel" @change="renderTOC">
                    <option value="2">H2</option>
                    <option value="3">H3</option>
                    <option value="4">H4</option>
                    <option value="5">H5</option>
                    <option value="6">H6</option>
                  </select>
                </div>
                <button class="toc-toggle" @click="tocCollapsed = !tocCollapsed">
                  {{ tocCollapsed ? '‚ñ∂' : '‚ñº' }}
                </button>
              </div>
            </div>
            <div class="toc-content">
              <ul class="toc-list">
                <li class="toc-item" v-for="heading in filteredHeadings" :key="heading.id">
                  <a class="toc-link" :class="{ active: activeHeadingId === heading.id, ['toc-level-' + heading.level]: true }" :href="'#' + heading.id" @click.prevent="scrollToHeading(heading.id)">{{ heading.text }}</a>
                </li>
              </ul>
            </div>
          </div>
        </div>
        
        <div class="main-content">
          <div class="markdown-body" ref="markdownContent" v-html="markdownHtml"></div>
        </div>
      </div>
    </main>

    <button class="back-to-top" :class="{ show: showBackToTop }" @click="scrollToTop">‚Üë</button>

    <div class="tooltip" :class="{ show: tooltip.show }" :style="{ left: tooltip.x + 'px', top: tooltip.y + 'px' }">{{ tooltip.message }}</div>

    <div class="temp-modal" :class="{ active: showTempModal }" @click.self="showTempModal = false">
      <div class="temp-modal-content">
        <h3>‰∏¥Êó∂È¢ÑËßà</h3>
        <textarea v-model="tempContent" placeholder="ËæìÂÖ•MarkdownÂÜÖÂÆπ..."></textarea>
        <div class="text-center"><button class="btn" @click="saveTemp">Á°ÆÂÆö</button>  <button class="btn" @click="showTempModal = false">ÂèñÊ∂à</button></div>
      </div>
    </div>
  </div>

  <script>
    const renderer = new marked.Renderer();
    renderer.link = ({ href, text }) => `<a href="${href}"${href.startsWith('http') ? ' target="_blank"' : ''}>${text}</a>`;
    marked.setOptions({
      highlight: function(code, lang) {
        if (Prism.languages[lang]) {
          return Prism.highlight(code, Prism.languages[lang], lang);
        }
        return code;
      },
      renderer: renderer,
      breaks: true,
      gfm: true
    });

    const { createApp } = Vue;

    createApp({
      data() {
        return {
          theme: localStorage.getItem('markdownTheme') || 'github',
          currentFile: null,
          showContent: false,
          markdownHtml: '',
          tocCollapsed: false,
          headings: [],
          maxTOCLevel: parseInt(localStorage.getItem('markdownTOCLevel') || '2'),
          activeHeadingId: null,
          showBackToTop: false,
          isDragOver: false,
          historyList: [],
          currentHistoryId: localStorage.getItem('markdownCurrentDoc') || null,
          showClearCacheBtn: false,
          tooltip: { show: false, message: '', x: 0, y: 0 },
          showTempModal: false,
          tempContent: localStorage.getItem('tempMarkdown') || '# ‰∏¥Êó∂È¢ÑËßà\n\nÂú®ËøôÈáåËæìÂÖ•MarkdownÂÜÖÂÆπ...'
        };
      },
      computed: {
        tempItem() {
          const content = localStorage.getItem('tempMarkdown') || '# ‰∏¥Êó∂È¢ÑËßà\n\nÂú®ËøôÈáåËæìÂÖ•MarkdownÂÜÖÂÆπ...';
          return {
            id: 'temp_md',
            name: 'temp.md',
            size: content.length,
            content: content,
            timestamp: Date.now(),
            isTemp: true
          };
        },
        displayHistoryList() {
          return [this.tempItem, ...this.historyList];
        },
        hasTOC() {
          return this.headings.length > 0;
        },
        filteredHeadings() {
          return this.headings.filter(h => h.level <= this.maxTOCLevel);
        },
        hasHistory() {
          return this.historyList.length > 0;
        }
      },
      mounted() {
        this.loadHistoryList();
        window.addEventListener('scroll', this.handleScroll);
        this.applyTheme();
        document.addEventListener('dragover', (e) => { e.preventDefault(); this.isDragOver = true; });
        document.addEventListener('dragleave', (e) => { e.preventDefault(); this.isDragOver = false; });
        document.addEventListener('drop', (e) => { 
          e.preventDefault(); 
          this.isDragOver = false; 
          const file = e.dataTransfer.files[0]; 
          if (file) this.processFile(file); 
        });
        if (this.currentHistoryId) {
          this.loadHistory(this.currentHistoryId);
        }
      },
      methods: {
        triggerFileInput() {
          this.$refs.fileInput.click();
        },
        handleFileSelect(e) {
          const file = e.target.files[0];
          if (file) this.processFile(file);
        },
        processFile(file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            const content = e.target.result;
            this.displayMarkdown(content, file);
            this.saveToCache(content, file);
          };
          reader.onerror = () => {
            this.showTooltip('Êñá‰ª∂ËØªÂèñÂ§±Ë¥•', window.innerWidth / 2, window.innerHeight / 2);
          };
          reader.readAsText(file);
        },
        displayMarkdown(content, file) {
          this.currentFile = file;
          this.markdownHtml = marked.parse(content);
          this.showContent = true;
          
          this.$nextTick(() => {
            this.generateTOC();
            Prism.highlightAllUnder(this.$refs.markdownContent);
            this.addCopyButtons();
            this.updateActiveHeading();
          });
        },
        generateTOC() {
          if (!this.$refs.markdownContent) return;
          const headers = this.$refs.markdownContent.querySelectorAll('h1, h2, h3, h4, h5, h6');
          this.headings = Array.from(headers).map((header, index) => {
            const id = `heading-${index}`;
            header.id = id;
            return {
              id,
              level: parseInt(header.tagName.substring(1)),
              text: header.textContent,
              element: header
            };
          });
        },
        renderTOC() {
          localStorage.setItem('markdownTOCLevel', this.maxTOCLevel);
          this.$nextTick(() => {
            this.updateActiveHeading();
          });
        },
        updateActiveHeading() {
          if (this.headings.length === 0) return;
          
          let activeId = null;
          const scrollY = window.scrollY;
          
          for (let i = this.headings.length - 1; i >= 0; i--) {
            const heading = this.headings[i];
            
            if (!heading.element || !document.body.contains(heading.element)) {
              const element = document.getElementById(heading.id);
              if (element) {
                heading.element = element;
              } else {
                continue;
              }
            }
            
            const rect = heading.element.getBoundingClientRect();
            const elementTop = rect.top + scrollY;
            
            if (scrollY >= elementTop - 120) {
              activeId = heading.id;
              break;
            }
          }
          
          if (activeId !== this.activeHeadingId) {
            this.activeHeadingId = activeId;
            this.$nextTick(() => {
              this.scrollActiveTOCItem();
            });
          }
        },
        scrollActiveTOCItem() {
          if (!this.$refs.tocContainer || !this.activeHeadingId) return;
          
          const activeLink = this.$refs.tocContainer.querySelector(`.toc-link.active`);
          if (activeLink) {
            const container = this.$refs.tocContainer;
            const containerHeight = container.clientHeight;
            const linkTop = activeLink.offsetTop;
            const linkHeight = activeLink.offsetHeight;
            
            container.scrollTop = linkTop - (containerHeight / 2) + (linkHeight / 2);
          }
        },
        handleScroll() {
          this.showBackToTop = window.scrollY > 300;
          this.updateActiveHeading();
        },
        scrollToHeading(id) {
          const heading = this.headings.find(h => h.id === id);
          if (heading) {
            const element = heading.element;
            const top = element.getBoundingClientRect().top + window.scrollY - 100;
            window.scrollTo({ top, behavior: 'auto' });
          }
        },
        scrollToTop() {
          window.scrollTo({ top: 0, behavior: 'smooth' });
        },
        formatFileSize(bytes) {
          if (!bytes) return '0 KB';
          const k = 1024;
          const sizes = ['Bytes', 'KB', 'MB', 'GB'];
          const i = Math.floor(Math.log(bytes) / Math.log(k));
          return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        },
        resetContent() {
          this.showContent = false;
          this.currentFile = null;
          this.markdownHtml = '';
          this.headings = [];
          this.currentHistoryId = null;
          if (this.$refs.fileInput) this.$refs.fileInput.value = '';
        },
        changeTheme() {
          document.documentElement.setAttribute('data-theme', this.theme);
          localStorage.setItem('markdownTheme', this.theme);
          const prismThemes = {
            light: 'prism.min.css',
            github: 'prism.min.css',
            dark: 'prism-tomorrow.min.css',
            vscode: 'prism-tomorrow.min.css'
          };
          const prismThemeLink = document.querySelector('link[href*="prism"]');
          if (prismThemeLink) {
            prismThemeLink.href = `https://cdnjs.cloudflare.com/ajax/libs/prism/1.30.0/themes/${prismThemes[this.theme]}`;
          }
          if (this.showContent) {
            Prism.highlightAllUnder(this.$refs.markdownContent);
            this.addCopyButtons();
          }
        },
        applyTheme() {
          document.documentElement.setAttribute('data-theme', this.theme);
        },
        showTooltip(message, x, y) {
          this.tooltip = { show: true, message, x, y };
          setTimeout(() => {
            this.tooltip.show = false;
          }, 2000);
        },
        saveToCache(content, file) {
          try {
            const maxFileSize = 200 * 1024;
            if (content.length > maxFileSize) return;
            
            let historyList = this.getHistoryList();
            const fileId = this.generateFileId(file);
            const existingIndex = historyList.findIndex(item => item.id === fileId);
            
            const fileRecord = {
              id: fileId,
              name: file.name,
              size: file.size,
              content: content,
              timestamp: Date.now()
            };
            
            if (existingIndex >= 0) {
              historyList[existingIndex] = fileRecord;
            } else {
              historyList.unshift(fileRecord);
              if (historyList.length > 10) historyList.pop();
            }
            
            localStorage.setItem('markdownHistory', JSON.stringify(historyList));
            this.historyList = historyList;
            this.showClearCacheBtn = true;
            this.currentHistoryId = fileId;
            localStorage.setItem('markdownCurrentDoc', fileId);
          } catch (e) {
            console.error('‰øùÂ≠òÁºìÂ≠òÂ§±Ë¥•:', e);
          }
        },
        getHistoryList() {
          try {
            const data = localStorage.getItem('markdownHistory');
            return data ? JSON.parse(data) : [];
          } catch (e) {
            return [];
          }
        },
        loadHistoryList() {
          this.historyList = this.getHistoryList();
          this.showClearCacheBtn = this.historyList.length > 0;
        },
        loadHistory(id) {
          const item = this.displayHistoryList.find(h => h.id === id);
          if (item) {
            this.currentHistoryId = id;
            localStorage.setItem('markdownCurrentDoc', id);
            if (item.isTemp) {
              this.tempContent = item.content;
              const file = { name: item.name, size: item.size };
              this.displayMarkdown(item.content, file);
            } else {
              const file = { name: item.name, size: item.size };
              this.displayMarkdown(item.content, file);
            }
          }
        },
        deleteHistoryItem(id) {
          this.historyList = this.historyList.filter(item => item.id !== id);
          localStorage.setItem('markdownHistory', JSON.stringify(this.historyList));
          if (this.currentHistoryId === id) {
            this.resetContent();
          }
          this.showClearCacheBtn = this.historyList.length > 0;
        },
        clearAllHistory() {
          this.historyList = [];
          localStorage.removeItem('markdownHistory');
          this.showClearCacheBtn = false;
          this.resetContent();
        },
        clearCache() {
          this.clearAllHistory();
        },
        generateFileId(file) {
          return file.name + '_' + file.size + '_' + file.lastModified;
        },
        addCopyButtons() {
          const codeBlocks = this.$refs.markdownContent.querySelectorAll('pre');
          codeBlocks.forEach(pre => {
            if (!pre.querySelector('.copy-button')) {
              const wrapper = document.createElement('div');
              wrapper.className = 'code-block-wrapper';
              pre.parentNode.insertBefore(wrapper, pre);
              wrapper.appendChild(pre);
              
              const button = document.createElement('button');
              button.className = 'copy-button';
              button.textContent = 'Â§çÂà∂';
              button.onclick = () => this.copyCode(pre, button);
              wrapper.appendChild(button);
            }
          });
        },
        copyCode(pre, button) {
          const code = pre.querySelector('code');
          const text = code.textContent;
          
          navigator.clipboard.writeText(text).then(() => {
            button.textContent = 'Â∑≤Â§çÂà∂';
            setTimeout(() => {
              button.textContent = 'Â§çÂà∂';
            }, 2000);
          }).catch(err => {
            this.showTooltip('Â§çÂà∂Â§±Ë¥•', window.innerWidth / 2, window.innerHeight / 2);
          });
        },
        openTempModal() {
          this.tempContent = localStorage.getItem('tempMarkdown') || '# ‰∏¥Êó∂È¢ÑËßà\n\nÂú®ËøôÈáåËæìÂÖ•MarkdownÂÜÖÂÆπ...';
          this.showTempModal = true;
        },
        saveTemp() {
          localStorage.setItem('tempMarkdown', this.tempContent);
          this.showTempModal = false;
          const file = { name: 'temp.md', size: this.tempContent.length };
          this.displayMarkdown(this.tempContent, file);
          this.currentHistoryId = 'temp_md';
          localStorage.setItem('markdownCurrentDoc', 'temp_md');
        },
        downloadFile() {
          const item = this.displayHistoryList.find(h => h.id === this.currentHistoryId);
          if (item && item.content) {
            const a = Object.assign(document.createElement('a'), { href: URL.createObjectURL(new Blob([item.content], { type: 'text/plain' })), download: item.name });
            document.body.appendChild(a).click();
            document.body.removeChild(a);
            URL.revokeObjectURL(a.href);
          }
        }
      }
    }).mount('#app');
  </script>
</body>
</html>